angular.module("dndLists",[]).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,n,r,t){return function(a,d,o){d.attr("draggable","true"),o.dndDisableIf&&a.$watch(o.dndDisableIf,function(e){d.attr("draggable",!e)}),d.on("dragstart",function(i){i=i.originalEvent||i,i.dataTransfer.setData("Text",angular.toJson(a.$eval(o.dndDraggable))),i.dataTransfer.effectAllowed=o.dndEffectAllowed||"move",d.addClass("dndDragging"),n(function(){d.addClass("dndDraggingSource")},0),r.dropEffect="none",t.isDragging=!0,t.dragType=o.dndType?a.$eval(o.dndType):void 0,e(o.dndDragstart)(a,{event:i}),i.stopPropagation()}),d.on("dragend",function(i){i=i.originalEvent||i;var f=r.dropEffect;a.$apply(function(){switch(f){case"move":e(o.dndMoved)(a,{event:i});break;case"copy":e(o.dndCopied)(a,{event:i});break;case"none":e(o.dndCanceled)(a,{event:i})}e(o.dndDragend)(a,{event:i,dropEffect:f})}),d.removeClass("dndDragging"),n(function(){d.removeClass("dndDraggingSource")},0),t.isDragging=!1,i.stopPropagation()}),d.on("click",function(n){o.dndSelected&&(n=n.originalEvent||n,a.$apply(function(){e(o.dndSelected)(a,{event:n})}),n.stopPropagation())}),d.on("selectstart",function(){this.dragDrop&&this.dragDrop()})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround",function(e,n,r,t){return function(a,d,o){function i(e,n,r){var t=D?e.offsetX||e.layerX:e.offsetY||e.layerY,a=D?n.offsetWidth:n.offsetHeight,d=D?n.offsetLeft:n.offsetTop;return d=r?d:0,d+a/2>t}function f(){return Array.prototype.indexOf.call(v.children,p)}function l(e){if(!t.isDragging&&!y)return!1;if(!u(e.dataTransfer.types))return!1;if(o.dndAllowedTypes&&t.isDragging){var n=a.$eval(o.dndAllowedTypes);if(angular.isArray(n)&&-1===n.indexOf(t.dragType))return!1}return o.dndDisableIf&&a.$eval(o.dndDisableIf)?!1:!0}function g(){return c.remove(),d.removeClass("dndDragover"),!0}function s(n,r,d,o){return e(n)(a,{event:r,index:d,item:o||void 0,external:!t.isDragging,type:t.isDragging?t.dragType:void 0})}function u(e){if(!e)return!0;for(var n=0;n<e.length;n++)if("Text"===e[n]||"text/plain"===e[n])return!0;return!1}var c=angular.element("<li class='dndPlaceholder'></li>"),p=c[0],v=d[0],D=o.dndHorizontalList&&a.$eval(o.dndHorizontalList),y=o.dndExternalSources&&a.$eval(o.dndExternalSources);d.on("dragover",function(e){if(e=e.originalEvent||e,!l(e))return!0;if(p.parentNode!=v&&d.append(c),e.target!==v){for(var n=e.target;n.parentNode!==v&&n.parentNode;)n=n.parentNode;n.parentNode===v&&n!==p&&(i(e,n)?v.insertBefore(p,n):v.insertBefore(p,n.nextSibling))}else if(i(e,p,!0))for(;p.previousElementSibling&&(i(e,p.previousElementSibling,!0)||0===p.previousElementSibling.offsetHeight);)v.insertBefore(p,p.previousElementSibling);else for(;p.nextElementSibling&&!i(e,p.nextElementSibling,!0);)v.insertBefore(p,p.nextElementSibling.nextElementSibling);return o.dndDragover&&!s(o.dndDragover,e,f())?g():(d.addClass("dndDragover"),e.preventDefault(),e.stopPropagation(),!1)}),d.on("drop",function(e){if(e=e.originalEvent||e,!l(e))return!0;e.preventDefault();var n,t=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain");try{n=JSON.parse(t)}catch(d){return g()}var i=f();if(o.dndDrop&&(n=s(o.dndDrop,e,i,n),!n))return g();var u=a.$eval(o.dndList);return a.$apply(function(){u.splice(i,0,n)}),s(o.dndInserted,e,i,n),r.dropEffect="none"===e.dataTransfer.dropEffect?"copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.effectAllowed:e.ctrlKey?"copy":"move":e.dataTransfer.dropEffect,g(),e.stopPropagation(),!1}),d.on("dragleave",function(e){e=e.originalEvent||e,d.removeClass("dndDragover"),n(function(){d.hasClass("dndDragover")||c.remove()},100)})}}]).directive("dndNodrag",function(){return function(e,n){n.attr("draggable","true"),n.on("dragstart",function(e){e=e.originalEvent||e,e.dataTransfer.types&&e.dataTransfer.types.length||e.preventDefault(),e.stopPropagation()}),n.on("dragend",function(e){e=e.originalEvent||e,e.stopPropagation()})}}).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}});
